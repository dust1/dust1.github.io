<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="咸鱼回响的博客">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        我们使用磁力的时候发生了什么？ - 咸鱼回响的博客 | 咸鱼回响&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 望之天迴，即之云昏 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/head.jpg" />
        </div>
        <div class="name">
            <i>咸鱼回响</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#磁力的诞生"><span class="toc-text">磁力的诞生</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第一步-获取种子"><span class="toc-text">第一步 获取种子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#种子中有什么？"><span class="toc-text">种子中有什么？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第二步-开始下载"><span class="toc-text">第二步 开始下载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关信息"><span class="toc-text">相关信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#磁力链接"><span class="toc-text">磁力链接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数"><span class="toc-text">参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHT"><span class="toc-text">DHT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tracker"><span class="toc-text">Tracker</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 望之天迴，即之云昏 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        我们使用磁力的时候发生了什么？
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-02-17 21:22:21</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#杂谈" title="杂谈">杂谈</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>前段时间使用磁力链接的时候突然想了解一下磁力链接是怎么工作的，于是查询了一下相关信息并在这里做一个记录。</p>
<h2 id="磁力的诞生"><a href="#磁力的诞生" class="headerlink" title="磁力的诞生"></a>磁力的诞生</h2><blockquote>
<p>这个标准的草稿出现于2002年，是为了对eDonkey2000的“ed2k:”和Freenet的“freenet:”两个URI格式进行“厂商与项目中立化”（vendor- and project-neutral generalization）而制定的。同时这个标准也尝试紧密地跟进IETF官方的URI标准。<br><br><a href="https://zh.wikipedia.org/wiki/%E7%A3%81%E5%8A%9B%E9%93%BE%E6%8E%A5#%E5%8E%86%E5%8F%B2" target="_blank" rel="noopener">维基百科</a></p>
</blockquote>
<h2 id="第一步-获取种子"><a href="#第一步-获取种子" class="headerlink" title="第一步 获取种子"></a>第一步 获取种子</h2><p>我们使用的磁力链接实际上是一个唯一的文件识别符类似于图书领域的ISBN，在计算机中通常叫做对应文件的散列值或者叫哈希值(Hash)。该字符指向一个唯一的文件，通常是种子文件。</p>
<p>我们在相关程序中输入磁力链接后，目标程序会从它们自己的种子库中搜索对应的种子。这是最常用的方法，但是还有一种方法就是启用DHT(Distributed Hash Table,分布式哈希表)这种方法效率就不太高了。客户端会从几个DHT的节点出发，根据磁力的散列值在表中查找种子文件。</p>
<blockquote>
<p>DHT:分布式哈希表，是一种分布式存储方法。每个客户端维护一部分路由表并存储一部分数据，其中保存的是其他节点的网络信息，包括IP以及端口。我们只要从部分哈希表节点出发就能遍历整个分布式网络。这部分节点称之为bootstrap node。现在网络上有各种个样的磁力客户端，不难想象这个网络有多大了。</p>
</blockquote>
<h3 id="种子中有什么？"><a href="#种子中有什么？" class="headerlink" title="种子中有什么？"></a>种子中有什么？</h3><p>种子中保存着Tracker信息和文件信息。</p>
<p>Tracker信息就是我们在下载中请求的下载服务器IP和相关配置。</p>
<p>文件信息就是根据目标文件的计算生成的，计算结果根据BitTorrent协议内的Bencode规则进行编码。它的主要原理是需要把提供下载的文件虚拟分成大小相等的块，块大小必须为2k的整数次方（由于是虚拟分块，硬盘上并不产生各个块文件），并把每个块的索引信息和Hash验证码写入种子文件中；所以，种子文件就是被下载文件的“索引”。 </p>
<h2 id="第二步-开始下载"><a href="#第二步-开始下载" class="headerlink" title="第二步 开始下载"></a>第二步 开始下载</h2><blockquote>
<p>当我们准备下载的时候首先要解析种子文件，然后使用BT客户端软件进行下载。 下载时，BT客户端首先解析种子文件得到Tracker地址，然后连接Tracker服务器。Tracker服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的IP。下载者再连接其他下载者，根据种子文件，两者分别告知对方自己已经有的块，然后交换对方所没有的数据。此时不需要其他服务器参与，分散了单个线路上的数据流量，因此减轻了服务器负担。 下载者每得到一个块，需要算出下载块的Hash验证码与种子文件中的对比，如果一样则说明块正确，不一样则需要重新下载这个块。这种规定是为了解决下载内容准确性的问题。 一般的HTTP/FTP下载，发布文件仅在某个或某几个服务器，下载的人太多，服务器的带宽很易不胜负荷，变得很慢。而BitTorrent协议下载的特点是，下载的人越多，提供的带宽也越多，下载速度就越快。同时，拥有完整文件的用户也会越来越多，使文件的“寿命”不断延长。<br><a href="https://zh.wikipedia.org/wiki/BitTorrent_(%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">维基百科</a>)</p>
</blockquote>
<p>这里在进行下载的时候实际上还要经过Tracker服务器，这样容易出现单点问题。于是DHT网络孕育而生。根据DHT规范网络中的每个DHT节点由peer和节点本身组成。</p>
<blockquote>
<p>peer：是一个在TCP上监听的客户端/服务端，它实现了BT协议。</p>
<p>节点：是一个在UDP上监听的客户端/服务端，它实现了分布式哈希表协议。并存储了peer的信息。</p>
</blockquote>
<p>当使用DHT进行下载时，我们从几个bootstrap node出发，此时他们的节点通过自身的路由表联系其他节点并获取其他节点的peer位置然后才能通过BT协议进行下载。</p>
<h2 id="相关信息"><a href="#相关信息" class="headerlink" title="相关信息"></a>相关信息</h2><h3 id="磁力链接"><a href="#磁力链接" class="headerlink" title="磁力链接"></a>磁力链接</h3><p>磁力链接类似与URL，根URL开头的HTTP/HTTPS一样，磁力链接的开头是 <code>magnet:?</code>。但是由于参数 <code>xt (&quot;exact topic&quot;的缩写)</code> 必须存在，所以也会写成 <code>magnet:?xt=</code>。</p>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul>
<li>xt(exact topic) - 包含文件散列值的URN。</li>
<li>dn(显示名称) - 文件名</li>
<li>xl(绝对长度) - 文件的字节数</li>
<li>as(可接受来源) - 在线文件的网络链接</li>
<li>xs(绝对资源) - P2P链接</li>
<li>kt(关键字) - 用于搜索的关键字</li>
<li>mt(文件列表) - 链接到一个包含磁力链接的元文件 (MAGMA - <a href="http://rakjar.de/gnuticles/MAGMA-Specsv22.txt" target="_blank" rel="noopener">MAGnet MAnifest</a>）</li>
<li>tr(Tracker地址) - BT下载的Tracker URL</li>
</ul>
<p>详情见<a href="https://zh.wikipedia.org/wiki/%E7%A3%81%E5%8A%9B%E9%93%BE%E6%8E%A5" target="_blank" rel="noopener">磁力链接</a></p>
<h4 id="DHT"><a href="#DHT" class="headerlink" title="DHT"></a>DHT</h4><p>Distributed Hash Table,分布式哈希表的缩写。是一种分布式存储技术。网络中的每个节点负责维护一个路由表，路由表保存部分有效的DHT节点，用户从某个或者某些节点出发就可以遍历完整个节点，并能够利用整个DHT网络的资源。</p>
<p>和数据结构中的图类似，其中的路由表就是图之间关联的线。</p>
<p>详情见<a href="https://max.book118.com/html/2015/1002/26541787.shtm" target="_blank" rel="noopener">DHT协议</a></p>
<h4 id="Tracker"><a href="#Tracker" class="headerlink" title="Tracker"></a>Tracker</h4><p>保存着文件的下载服务器地址与相关配置。可以追踪某文件同时被多少人在下载。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.aneasystone.com/archives/2015/05/how-does-magnet-link-work.html" target="_blank" rel="noopener">磁力链接是如何下载的</a></p>
<p><a href="https://max.book118.com/html/2015/1002/26541787.shtm" target="_blank" rel="noopener">DHT协议规范</a></p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/dust1">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://www.baidu.com">百度</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://airclouds-blog.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>



</html>
